!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).BareClient=t()}(this,(function(){"use strict";const e=globalThis,t=e.fetch,s=e.WebSocket,a=e.Request,r=e.Response,n=[101,204,205,304],o=[301,302,303,307,308];class i extends Error{status;body;constructor(e,t){super(t.message||t.code),this.status=e,this.body=t}}class c{base;constructor(e,t){this.base=new URL(`./v${e}/`,t)}}const h="!#$%&'*+-.0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ^_`abcdefghijklmnopqrstuvwxyz|~";function d(e){for(let t=0;t<e.length;t++){const s=e[t];if(!h.includes(s))return!1}return!0}function w(e){let t="";for(let s=0;s<e.length;s++){const a=e[s];if(h.includes(a)&&"%"!==a)t+=a;else{t+="%"+a.charCodeAt(0).toString(16).padStart(2,"0")}}return t}function u(e,t){const s=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(s>>16)<<16|65535&s}function l(e,t,s,a,r,n){return u((o=u(u(t,e),u(a,n)))<<(i=r)|o>>>32-i,s);var o,i}function f(e,t,s,a,r,n,o){return l(t&s|~t&a,e,t,r,n,o)}function b(e,t,s,a,r,n,o){return l(t&a|s&~a,e,t,r,n,o)}function p(e,t,s,a,r,n,o){return l(t^s^a,e,t,r,n,o)}function g(e,t,s,a,r,n,o){return l(s^(t|~a),e,t,r,n,o)}function x(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;let s=1732584193,a=-271733879,r=-1732584194,n=271733878;for(let t=0;t<e.length;t+=16){const o=s,i=a,c=r,h=n;s=f(s,a,r,n,e[t],7,-680876936),n=f(n,s,a,r,e[t+1],12,-389564586),r=f(r,n,s,a,e[t+2],17,606105819),a=f(a,r,n,s,e[t+3],22,-1044525330),s=f(s,a,r,n,e[t+4],7,-176418897),n=f(n,s,a,r,e[t+5],12,1200080426),r=f(r,n,s,a,e[t+6],17,-1473231341),a=f(a,r,n,s,e[t+7],22,-45705983),s=f(s,a,r,n,e[t+8],7,1770035416),n=f(n,s,a,r,e[t+9],12,-1958414417),r=f(r,n,s,a,e[t+10],17,-42063),a=f(a,r,n,s,e[t+11],22,-1990404162),s=f(s,a,r,n,e[t+12],7,1804603682),n=f(n,s,a,r,e[t+13],12,-40341101),r=f(r,n,s,a,e[t+14],17,-1502002290),a=f(a,r,n,s,e[t+15],22,1236535329),s=b(s,a,r,n,e[t+1],5,-165796510),n=b(n,s,a,r,e[t+6],9,-1069501632),r=b(r,n,s,a,e[t+11],14,643717713),a=b(a,r,n,s,e[t],20,-373897302),s=b(s,a,r,n,e[t+5],5,-701558691),n=b(n,s,a,r,e[t+10],9,38016083),r=b(r,n,s,a,e[t+15],14,-660478335),a=b(a,r,n,s,e[t+4],20,-405537848),s=b(s,a,r,n,e[t+9],5,568446438),n=b(n,s,a,r,e[t+14],9,-1019803690),r=b(r,n,s,a,e[t+3],14,-187363961),a=b(a,r,n,s,e[t+8],20,1163531501),s=b(s,a,r,n,e[t+13],5,-1444681467),n=b(n,s,a,r,e[t+2],9,-51403784),r=b(r,n,s,a,e[t+7],14,1735328473),a=b(a,r,n,s,e[t+12],20,-1926607734),s=p(s,a,r,n,e[t+5],4,-378558),n=p(n,s,a,r,e[t+8],11,-2022574463),r=p(r,n,s,a,e[t+11],16,1839030562),a=p(a,r,n,s,e[t+14],23,-35309556),s=p(s,a,r,n,e[t+1],4,-1530992060),n=p(n,s,a,r,e[t+4],11,1272893353),r=p(r,n,s,a,e[t+7],16,-155497632),a=p(a,r,n,s,e[t+10],23,-1094730640),s=p(s,a,r,n,e[t+13],4,681279174),n=p(n,s,a,r,e[t],11,-358537222),r=p(r,n,s,a,e[t+3],16,-722521979),a=p(a,r,n,s,e[t+6],23,76029189),s=p(s,a,r,n,e[t+9],4,-640364487),n=p(n,s,a,r,e[t+12],11,-421815835),r=p(r,n,s,a,e[t+15],16,530742520),a=p(a,r,n,s,e[t+2],23,-995338651),s=g(s,a,r,n,e[t],6,-198630844),n=g(n,s,a,r,e[t+7],10,1126891415),r=g(r,n,s,a,e[t+14],15,-1416354905),a=g(a,r,n,s,e[t+5],21,-57434055),s=g(s,a,r,n,e[t+12],6,1700485571),n=g(n,s,a,r,e[t+3],10,-1894986606),r=g(r,n,s,a,e[t+10],15,-1051523),a=g(a,r,n,s,e[t+1],21,-2054922799),s=g(s,a,r,n,e[t+8],6,1873313359),n=g(n,s,a,r,e[t+15],10,-30611744),r=g(r,n,s,a,e[t+6],15,-1560198380),a=g(a,r,n,s,e[t+13],21,1309151649),s=g(s,a,r,n,e[t+4],6,-145523070),n=g(n,s,a,r,e[t+11],10,-1120210379),r=g(r,n,s,a,e[t+2],15,718787259),a=g(a,r,n,s,e[t+9],21,-343485551),s=u(s,o),a=u(a,i),r=u(r,c),n=u(n,h)}return[s,a,r,n]}function y(e){let t="";const s=32*e.length;for(let a=0;a<s;a+=8)t+=String.fromCharCode(e[a>>5]>>>a%32&255);return t}function m(e){const t=[],s=e.length>>2;for(let e=0;e<s;e+=1)t[e]=0;const a=8*e.length;for(let s=0;s<a;s+=8)t[s>>5]|=(255&e.charCodeAt(s/8))<<s%32;return t}function R(e){const t="0123456789abcdef";let s="";for(let a=0;a<e.length;a+=1){const r=e.charCodeAt(a);s+=t.charAt(r>>>4&15)+t.charAt(15&r)}return s}function E(e){return unescape(encodeURIComponent(e))}function H(e){return function(e){return y(x(m(e),8*e.length))}(E(e))}function v(e,t){return function(e,t){let s=m(e);const a=[],r=[];s.length>16&&(s=x(s,8*e.length));for(let e=0;e<16;e+=1)a[e]=909522486^s[e],r[e]=1549556828^s[e];const n=x(a.concat(m(t)),512+8*t.length);return y(x(r.concat(n),640))}(E(e),E(t))}function L(e,t,s){return t?s?v(t,e):R(v(t,e)):s?H(e):R(H(e))}const k=3072;const S=[["v2",class extends c{ws;http;newMeta;getMeta;constructor(e){super(2,e),this.ws=new URL(this.base),this.http=new URL(this.base),this.newMeta=new URL("./ws-new-meta",this.base),this.getMeta=new URL("./ws-meta",this.base),"https:"===this.ws.protocol?this.ws.protocol="wss:":this.ws.protocol="ws:"}async connect(e,r,n,o,c){const h=new a(this.newMeta,{headers:this.createBareHeaders(r,n,c,o,e)}),d=await t(h);if(!d.ok)throw new i(d.status,await d.json());const w=await d.text(),u=new s(this.ws,[w]);return u.meta=new Promise(((e,s)=>{u.addEventListener("open",(async()=>{const s=await t(this.getMeta,{headers:{"x-bare-id":w},method:"GET"});e(await await this.readBareResponse(s))})),u.addEventListener("error",s)})),u}async request(e,s,o,i,c,h,d,w,u){if(i.startsWith("blob:")){const e=await t(`blob:${location.origin}${d}`),s=new r(e.body,e);return s.rawHeaders=Object.fromEntries(e.headers),s.rawResponse=e,s}const l={};if(s instanceof Headers)for(const[e,t]of s)l[e]=t;else for(const e in s)l[e]=s[e];const f={credentials:"omit",method:e,signal:u};"only-if-cached"!==w&&(f.cache=w),void 0!==o&&(f.body=o),f.headers=this.createBareHeaders(i,c,d,h,l);const b=new a(this.http+"?cache="+L(`${i}${c}${h}${d}`),f),p=await t(b),g=await this.readBareResponse(p),x=new r(n.includes(g.status)?void 0:p.body,{status:g.status,statusText:g.statusText??void 0,headers:g.headers});return x.rawHeaders=g.rawHeaders,x.rawResponse=p,x}async readBareResponse(e){if(!e.ok)throw new i(e.status,await e.json());const t=function(e){const t=new Headers(e),s="x-bare-headers";if(e.has(`${s}-0`)){const a=[];for(const[r,n]of e)if(r.startsWith(s)){if(!n.startsWith(";"))throw new i(400,{code:"INVALID_BARE_HEADER",id:`request.headers.${r}`,message:"Value didn't begin with semi-colon."});a[parseInt(r.slice(s.length+1))]=n.slice(1),t.delete(r)}t.set(s,a.join(""))}return t}(e.headers),s={};return t.has("x-bare-status")&&(s.status=parseInt(t.get("x-bare-status"))),t.has("x-bare-status-text")&&(s.statusText=t.get("x-bare-status-text")),t.has("x-bare-headers")&&(s.rawHeaders=JSON.parse(t.get("x-bare-headers")),s.headers=new Headers(s.rawHeaders)),s}createBareHeaders(e,t,s,a,r,n=[],o=[],i=[]){const c=new Headers;c.set("x-bare-protocol",e),c.set("x-bare-host",t),c.set("x-bare-path",s),c.set("x-bare-port",a.toString()),c.set("x-bare-headers",JSON.stringify(r));for(const e of n)c.append("x-bare-forward-headers",e);for(const e of o)c.append("x-bare-pass-headers",e);for(const e of i)c.append("x-bare-pass-status",e.toString());return function(e){const t=new Headers(e);if(e.has("x-bare-headers")){const s=e.get("x-bare-headers");if(s.length>k){t.delete("x-bare-headers");let e=0;for(let a=0;a<s.length;a+=k){const r=s.slice(a,a+k),n=e++;t.set(`x-bare-headers-${n}`,`;${r}`)}}}}(c),c}}],["v1",class extends c{ws;http;newMeta;getMeta;constructor(e){super(1,e),this.ws=new URL(this.base),this.http=new URL(this.base),this.newMeta=new URL("ws-new-meta",this.base),this.getMeta=new URL("ws-meta",this.base),"https:"===this.ws.protocol?this.ws.protocol="wss:":this.ws.protocol="ws:"}async connect(e,a,r,n,o){const c=await t(this.newMeta,{method:"GET"});if(!c.ok)throw new i(c.status,await c.json());const h=await c.text(),d=new s(this.ws,["bare",w(JSON.stringify({remote:{protocol:a,host:r,port:n,path:o},headers:e,forward_headers:["accept-encoding","accept-language","sec-websocket-extensions","sec-websocket-key","sec-websocket-version"],id:h}))]);return d.meta=new Promise(((e,s)=>{d.addEventListener("open",(async()=>{const a=await t(this.getMeta,{headers:{"x-bare-id":h},method:"GET"});a.ok||s(new i(a.status,await a.json())),e(await a.json())})),d.addEventListener("error",s)})),d}async request(e,s,o,i,c,h,d,w,u){if(i.startsWith("blob:")){const e=await t(`blob:${location.origin}${d}`),s=new r(e.body,e);return s.rawHeaders=Object.fromEntries(e.headers),s.rawResponse=e,s}const l={};if(s instanceof Headers)for(const[e,t]of s)l[e]=t;else for(const e in s)l[e]=s[e];const f={credentials:"omit",method:e,signal:u};void 0!==o&&(f.body=o);const b=new a(this.http,f);this.writeBareRequest(b,i,c,d,h,l,["accept-encoding","accept-language"]);const p=await t(b),g=await this.readBareResponse(p),x=new r(n.includes(g.status)?void 0:p.body,{status:g.status,statusText:g.statusText??void 0,headers:g.headers});return x.rawHeaders=g.rawHeaders,x.rawResponse=p,x}async readBareResponse(e){if(!e.ok)throw new i(e.status,await e.json());const t=["x-bare-status","x-bare-status-text","x-bare-headers"];for(const s of t)if(!e.headers.has(s))throw new i(500,{code:"IMPL_MISSING_BARE_HEADER",id:`response.headers.${s}`});const s=parseInt(e.headers.get("x-bare-status")),a=e.headers.get("x-bare-status-text"),r=JSON.parse(e.headers.get("x-bare-headers"));return{status:s,statusText:a,rawHeaders:r,headers:new Headers(r)}}writeBareRequest(e,t,s,a,r,n,o){e.headers.set("x-bare-protocol",t),e.headers.set("x-bare-host",s),e.headers.set("x-bare-path",a),e.headers.set("x-bare-port",r.toString()),e.headers.set("x-bare-headers",JSON.stringify(n)),e.headers.set("x-bare-forward-headers",JSON.stringify(o))}}]];return class{data;client;server;ready;constructor(e,t){this.server=new URL(e),this.ready=!1,"object"==typeof t&&this.loadData(t)}loadData(e){let t=!1;for(const[s,a]of S)if(e.versions.includes(s)){this.client=new a(this.server),t=!0;break}if(!t)throw new Error("Unable to find compatible client version.");this.data=e,this.ready=!0}async work(){if(!0===this.ready)return;const e=await t(this.server);if(!e.ok)throw new Error(`Unable to fetch Bare meta: ${e.status} ${await e.text()}`);this.loadData(await e.json())}async request(e,t,s,a,r,n,o,i,c){return await this.work(),await this.client.request(e,t,s,a,r,n,o,i,c)}async connect(e,t,s,a,r){return await this.work(),this.client.connect(e,t,s,a,r)}async createWebSocket(e,t={},s=[]){const a=t instanceof Headers?Object.fromEntries(t):t;e=new URL(e),a.Host=e.host,a.Pragma="no-cache",a["Cache-Control"]="no-cache",a.Upgrade="websocket",a.Connection="Upgrade","string"==typeof s&&(s=[s]);for(const e of s)if(!d(e))throw new DOMException(`Failed to construct 'WebSocket': The subprotocol '${e}' is invalid.`);return s.length&&(t["Sec-Websocket-Protocol"]=s.join(", ")),await this.work(),this.client.connect(t,e.protocol,e.hostname,e.port,e.pathname+e.search)}async fetch(e,t={}){let s,r,n,i,c;e instanceof a?(t||(t=e),e=new URL(e.url)):e=new URL(e),s="string"==typeof t.method?t.method:"GET",void 0!==t.body&&null!==t.body&&(r=t.body),n="object"==typeof t.headers&&null!==t.headers?t.headers instanceof Headers?Object.fromEntries(t.headers):t.headers:{},i="string"==typeof t.cache?t.cache:"default",t.signal instanceof AbortSignal&&(c=t.signal);for(let a=0;;a++){let h;h=""===e.port?"https:"===e.protocol?"443":"80":e.port,n.host=e.host;const d=await this.request(s,n,r,e.protocol,e.hostname,h,e.pathname+e.search,i,c);if(d.finalURL=e.toString(),!o.includes(d.status))return d;switch(t.redirect){default:case"follow":if(20>a&&d.headers.has("location")){e=new URL(d.headers.get("location"),e);continue}throw new TypeError("Failed to fetch");case"error":throw new TypeError("Failed to fetch");case"manual":return d}}}}}));
//# sourceMappingURL=BareClient.umd.min.cjs.map
